- name: Docker コンテナ ビルド＆起動
  hosts: localhost
  gather_facts: yes
  vars_files:
    - vars/secrets.yml

  tasks:
    - name: Docker Compose コマンドの存在確認
      block:

        - name: docker-compose（旧式）の存在確認
          command: which docker-compose
          register: docker_compose_old
          ignore_errors: true

        - name: docker compose（プラグイン）の存在確認
          command: docker compose version
          register: docker_compose_plugin
          ignore_errors: true

        - name: Docker Compose（旧式）でビルド＆起動
          when: docker_compose_old.rc == 0
          shell: docker-compose build --no-cache && docker-compose up -d
          args:
            chdir: "{{ playbook_dir }}/docker"

        - name: Docker Compose（プラグイン）でビルド＆起動
          when:
            - docker_compose_old.rc != 0
            - docker_compose_plugin.rc == 0
          shell: docker compose build --no-cache && docker compose up -d
          args:
            chdir: "{{ playbook_dir }}/docker"

        - name: Docker Compose が存在しない場合の通知
          when:
            - docker_compose_old.rc != 0
            - docker_compose_plugin.rc != 0
          debug:
            msg: "❌ Docker Compose（旧式/プラグイン）が見つかりませんでした。"