- name: FastAPI Docker 環境の完全リセット
  hosts: localhost
  gather_facts: yes
  vars_files:
    - vars/secrets.yml

  vars:
    project_dir: "{{ playbook_dir }}/docker"

  tasks:

    - name: docker-compose（旧式）の存在確認
      command: which docker-compose
      register: docker_compose_old
      ignore_errors: yes
      changed_when: false

    - name: docker compose（プラグイン）の存在確認
      command: docker compose version
      register: docker_compose_plugin
      ignore_errors: yes
      changed_when: false

    - name: docker-compose 旧式で停止
      shell: docker-compose down
      args:
        chdir: "{{ project_dir }}"
      when: docker_compose_old.rc == 0

    - name: docker compose プラグインで停止
      shell: docker compose down
      args:
        chdir: "{{ project_dir }}"
      when:
        - docker_compose_old.rc != 0
        - docker_compose_plugin.rc == 0

    # ================================
    # プロジェクト名を取得
    # ================================
    - name: compose プロジェクト名を取得
      shell: docker compose ls --format '{{"{{"}}.Name{{"}}"}}'
      args:
        chdir: "{{ project_dir }}"
      register: project_name_result
      ignore_errors: yes

    - name: プロジェクト名をセット
      set_fact:
        project_name: "{{ project_name_result.stdout | trim }}"
      when:
        - project_name_result.stdout is defined
        - project_name_result.stdout | trim != ""

    # ================================
    # コンテナ削除
    # ================================
    - name: コンテナ一覧取得
      shell: docker ps -a --filter "name={{ project_name }}" --format '{{"{{"}}.ID{{"}}"}}'
      register: target_containers
      when: project_name is defined
      ignore_errors: yes

    - name: コンテナ削除
      shell: docker rm -f {{ item }}
      loop: "{{ target_containers.stdout_lines }}"
      when: item != ""
      ignore_errors: yes

    # ================================
    # イメージ削除
    # ================================
    - name: イメージ一覧取得
      shell: docker images --filter "reference={{ project_name }}*" --format '{{"{{"}}.ID{{"}}"}}'
      register: target_images
      when: project_name is defined
      ignore_errors: yes

    - name: イメージ削除
      shell: docker rmi {{ item }}
      loop: "{{ target_images.stdout_lines }}"
      when: item != ""
      ignore_errors: yes

    # ================================
    # Volume 削除
    # ================================
    - name: サービス名一覧を取得
      command: docker compose ps --format '{{"{{"}}.Service{{"}}"}}'
      args:
        chdir: "{{ project_dir }}"
      register: project_services
      when: project_name is defined
      ignore_errors: yes

    - name: volume 削除
      shell: docker volume rm {{ project_name }}_{{ item }}
      loop: "{{ project_services.stdout_lines }}"
      when:
        - project_name is defined
        - item != ""
      ignore_errors: yes

    # ================================
    # BuildKit キャッシュ削除
    # ================================
    - name: BuildKit キャッシュ削除
      shell: docker builder prune -f
      ignore_errors: yes